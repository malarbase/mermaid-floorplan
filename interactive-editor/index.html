<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Floorplan Editor</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        overflow: hidden;
        background: #1a1a1a;
      }
      
      .container {
        display: flex;
        width: 100vw;
        height: 100vh;
      }
      
      /* Left panel: Code editor */
      .editor-panel {
        width: 40%;
        min-width: 300px;
        max-width: 600px;
        height: 100%;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #333;
        background: #1e1e1e;
      }
      
      .editor-header {
        padding: 12px 16px;
        background: #252526;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      
      .editor-header h2 {
        font-size: 14px;
        font-weight: 500;
        color: #ccc;
      }
      
      .editor-header-right {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .editor-status {
        font-size: 12px;
        color: #888;
      }
      
      /* Export dropdown */
      .export-dropdown {
        position: relative;
      }
      
      .export-btn {
        background: #3c3c3c;
        border: 1px solid #555;
        color: #ccc;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .export-btn:hover {
        background: #4a4a4a;
        border-color: #666;
      }
      
      .export-btn::after {
        content: '‚ñæ';
        font-size: 10px;
        margin-left: 2px;
      }
      
      .export-menu {
        position: absolute;
        top: 100%;
        right: 0;
        margin-top: 4px;
        background: #2d2d2d;
        border: 1px solid #555;
        border-radius: 4px;
        min-width: 160px;
        z-index: 300;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      
      .export-menu.visible {
        display: block;
      }
      
      .export-menu-item {
        padding: 8px 12px;
        font-size: 12px;
        color: #ccc;
        cursor: pointer;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .export-menu-item:hover {
        background: #3c3c3c;
      }
      
      .export-menu-item:first-child {
        border-radius: 3px 3px 0 0;
      }
      
      .export-menu-item:last-child {
        border-radius: 0 0 3px 3px;
      }
      
      .export-menu-item .ext {
        color: #888;
        font-size: 11px;
      }
      
      .export-menu-divider {
        height: 1px;
        background: #444;
        margin: 4px 0;
      }
      
      /* Add Room button */
      .add-room-btn {
        background: #2d5a2d;
        border: 1px solid #4a8a4a;
        color: #8f8;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 4px;
      }
      
      .add-room-btn:hover {
        background: #3a6a3a;
        border-color: #5a9a5a;
      }
      
      .add-room-btn::before {
        content: '+';
        font-weight: bold;
        font-size: 14px;
      }
      
      /* Add room dialog */
      .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 400;
        display: none;
        align-items: center;
        justify-content: center;
      }
      
      .dialog-overlay.visible {
        display: flex;
      }
      
      .dialog {
        background: #2d2d2d;
        border: 1px solid #555;
        border-radius: 8px;
        padding: 20px;
        min-width: 320px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      }
      
      .dialog-title {
        font-size: 16px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 16px;
      }
      
      .dialog-field {
        margin-bottom: 12px;
      }
      
      .dialog-field label {
        display: block;
        font-size: 12px;
        color: #999;
        margin-bottom: 4px;
      }
      
      .dialog-field input {
        width: 100%;
        background: #1e1e1e;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 8px 10px;
        color: #fff;
        font-size: 13px;
      }
      
      .dialog-field input:focus {
        outline: none;
        border-color: #4a9eff;
      }
      
      .dialog-row {
        display: flex;
        gap: 12px;
      }
      
      .dialog-row .dialog-field {
        flex: 1;
      }
      
      .dialog-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 20px;
      }
      
      .dialog-btn {
        padding: 8px 16px;
        border-radius: 4px;
        font-size: 13px;
        cursor: pointer;
        border: 1px solid transparent;
      }
      
      .dialog-btn.cancel {
        background: #3c3c3c;
        border-color: #555;
        color: #ccc;
      }
      
      .dialog-btn.cancel:hover {
        background: #4a4a4a;
      }
      
      .dialog-btn.primary {
        background: #2d5a2d;
        border-color: #4a8a4a;
        color: #8f8;
      }
      
      .dialog-btn.primary:hover {
        background: #3a6a3a;
      }
      
      .dialog-error {
        color: #f44;
        font-size: 12px;
        margin-top: 8px;
        display: none;
      }
      
      .dialog-error.visible {
        display: block;
      }
      
      .editor-status.error {
        color: #f44;
      }
      
      .editor-status.success {
        color: #4a4;
      }
      
      #editor-container {
        flex: 1;
        overflow: hidden;
      }
      
      /* Right panel: 3D viewer */
      .viewer-panel {
        flex: 1;
        position: relative;
        background: #1a1a1a;
      }
      
      #app {
        width: 100%;
        height: 100%;
      }
      
      /* Info panel overlay */
      .info-panel {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 16px;
        border-radius: 8px;
        font-size: 13px;
        max-width: 280px;
        z-index: 100;
        border: 1px solid #333;
      }
      
      .info-panel h3 {
        margin-bottom: 8px;
        font-size: 12px;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .info-panel p {
        margin-bottom: 4px;
        color: #ccc;
        font-size: 12px;
      }
      
      .key {
        display: inline-block;
        background: #333;
        padding: 1px 5px;
        border-radius: 3px;
        font-family: monospace;
        font-size: 11px;
        margin: 0 2px;
        border: 1px solid #555;
      }
      
      .mode-toggle {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #444;
      }
      
      .mode-toggle label {
        display: flex;
        align-items: center;
        gap: 6px;
        cursor: pointer;
        color: #ccc;
        font-size: 12px;
      }
      
      .mode-toggle input[type="checkbox"] {
        width: 14px;
        height: 14px;
        cursor: pointer;
      }
      
      .mode-indicator {
        margin-top: 6px;
        padding: 4px 8px;
        background: #2a2a2a;
        border-radius: 4px;
        font-size: 11px;
        color: #4a9eff;
      }
      
      /* Control Panel (viewer-style) */
      #controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(30, 30, 30, 0.95);
        padding: 0;
        border-radius: 10px;
        width: 260px;
        max-height: calc(100vh - 20px);
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        z-index: 100;
        border: 1px solid #444;
        font-size: 13px;
      }
      
      .control-section {
        border-bottom: 1px solid #3c3c3c;
      }
      
      .control-section:last-child {
        border-bottom: none;
      }
      
      .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        background: #2a2a2a;
        font-weight: 600;
        font-size: 13px;
        color: #ccc;
        transition: background 0.2s;
      }
      
      .section-header:hover {
        background: #333;
      }
      
      .section-header::after {
        content: '‚ñº';
        font-size: 10px;
        transition: transform 0.2s;
        color: #888;
      }
      
      .control-section.collapsed .section-header::after {
        transform: rotate(-90deg);
      }
      
      .section-content {
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        background: #252526;
      }
      
      .control-section.collapsed .section-content {
        display: none;
      }
      
      .control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .control-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }
      
      #controls label {
        font-size: 12px;
        font-weight: 500;
        color: #aaa;
      }
      
      .slider-value {
        font-size: 11px;
        color: #888;
        min-width: 35px;
        text-align: right;
      }
      
      #controls input[type="range"] {
        flex: 1;
        height: 4px;
        border-radius: 2px;
        -webkit-appearance: none;
        background: #555;
      }
      
      #controls input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #4a90d9;
        cursor: pointer;
        border: 2px solid #1e1e1e;
        box-shadow: 0 1px 3px rgba(0,0,0,0.4);
      }
      
      #controls button {
        padding: 8px 12px;
        background: #4a90d9;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: background 0.2s;
      }
      
      #controls button:hover {
        background: #5aa0e9;
      }
      
      .btn-secondary {
        background: #444 !important;
      }
      
      .btn-secondary:hover {
        background: #555 !important;
      }
      
      .btn-group {
        display: flex;
        gap: 8px;
      }
      
      .btn-group button {
        flex: 1;
      }
      
      .checkbox-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .checkbox-row input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      
      .checkbox-row label {
        cursor: pointer;
        flex: 1;
      }
      
      .unit-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .unit-row select {
        width: 100px;
      }
      
      #controls select {
        padding: 6px 8px;
        border: 1px solid #555;
        border-radius: 4px;
        font-size: 12px;
        background: #333;
        color: #ccc;
        cursor: pointer;
      }
      
      /* Floor list */
      .floor-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .floor-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
      }
      
      .floor-item input[type="checkbox"] {
        width: 16px;
        height: 16px;
        cursor: pointer;
      }
      
      .floor-item label {
        cursor: pointer;
        flex: 1;
        font-size: 12px;
        color: #ccc;
      }
      
      .floor-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }
      
      .floor-actions button {
        flex: 1;
        padding: 6px 8px;
        font-size: 11px;
      }
      
      .no-floors-message {
        color: #888;
        font-size: 11px;
        font-style: italic;
      }
      
      /* Scrollbar styling for controls */
      #controls::-webkit-scrollbar {
        width: 6px;
      }
      
      #controls::-webkit-scrollbar-track {
        background: #2a2a2a;
        border-radius: 3px;
      }
      
      #controls::-webkit-scrollbar-thumb {
        background: #555;
        border-radius: 3px;
      }
      
      #controls::-webkit-scrollbar-thumb:hover {
        background: #666;
      }
      
      /* 2D Overlay Mini-map */
      #overlay-2d {
        position: absolute;
        bottom: 80px;
        left: 10px;
        width: 280px;
        height: 220px;
        background: rgba(30, 30, 30, 0.95);
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        overflow: hidden;
        z-index: 50;
        display: none;
        border: 1px solid #444;
      }
      
      #overlay-2d.visible {
        display: block;
      }
      
      #overlay-2d-header {
        background: #2a2a2a;
        padding: 8px 12px;
        font-size: 12px;
        font-weight: 600;
        color: #ccc;
        border-bottom: 1px solid #3c3c3c;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: grab;
        user-select: none;
      }
      
      #overlay-2d-header:active {
        cursor: grabbing;
      }
      
      #overlay-2d-close {
        background: none;
        border: none;
        font-size: 18px;
        line-height: 1;
        color: #888;
        cursor: pointer;
        padding: 0 4px;
        border-radius: 4px;
        transition: background 0.15s, color 0.15s;
      }
      
      #overlay-2d-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
      }
      
      #overlay-2d.dragging {
        opacity: 0.9;
        transition: none;
      }
      
      #overlay-2d-resize {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 16px;
        height: 16px;
        cursor: nwse-resize;
        background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.15) 50%);
        border-radius: 0 0 8px 0;
      }
      
      #overlay-2d-resize:hover {
        background: linear-gradient(135deg, transparent 50%, rgba(255,255,255,0.3) 50%);
      }
      
      #overlay-2d-content {
        width: 100%;
        height: calc(100% - 32px);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
      }
      
      #overlay-2d-content svg {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
      }
      
      #overlay-2d-empty {
        color: #888;
        font-size: 11px;
        font-style: italic;
      }
      
      /* Floor Summary Panel */
      #floor-summary {
        position: absolute;
        bottom: 80px;
        right: 10px;
        background: rgba(30, 30, 30, 0.95);
        border-radius: 8px;
        padding: 12px 16px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        font-size: 12px;
        max-width: 300px;
        display: none;
        border: 1px solid #444;
        color: #ccc;
      }
      
      #floor-summary.visible {
        display: block;
      }
      
      .floor-summary-title {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 10px;
        color: #e0e0e0;
      }
      
      .floor-summary-item {
        padding: 8px 0;
        border-bottom: 1px solid #3c3c3c;
      }
      
      .floor-summary-item:last-child {
        border-bottom: none;
      }
      
      .floor-name {
        font-weight: 500;
        color: #4a90d9;
        margin-bottom: 4px;
      }
      
      .floor-stats {
        display: flex;
        gap: 12px;
        color: #888;
      }
      
      /* Annotation Labels (CSS2D) */
      .area-label {
        background: rgba(74, 144, 217, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      }
      
      .dimension-label {
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        white-space: nowrap;
        font-weight: 500;
        box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      }
      
      /* Width label - teal */
      .width-label {
        background: rgba(0, 150, 136, 0.9);
      }
      
      /* Depth label - orange */
      .depth-label {
        background: rgba(255, 152, 0, 0.9);
      }
      
      /* Height label - purple */
      .height-label {
        background: rgba(156, 39, 176, 0.9);
      }
      
      /* Selection info panel */
      .selection-info {
        position: absolute;
        bottom: 16px;
        right: 16px;
        background: rgba(0, 0, 0, 0.85);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 100;
        border: 1px solid #333;
        min-width: 180px;
        display: none; /* Hidden by default */
      }
      
      .selection-info.visible {
        display: block;
      }
      
      .selection-info.has-selection {
        border-color: #00ff00;
        background: rgba(0, 40, 0, 0.85);
      }
      
      .selection-info .count {
        font-size: 20px;
        font-weight: bold;
        color: #00ff00;
        margin-bottom: 2px;
      }
      
      .selection-info .details {
        color: #aaa;
        font-size: 11px;
      }
      
      /* Resizer */
      .resizer {
        width: 4px;
        background: #333;
        cursor: col-resize;
        transition: background 0.2s;
      }
      
      .resizer:hover {
        background: #4a9eff;
      }
      
      /* Error banner */
      .error-banner {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 8px 16px;
        background: rgba(244, 67, 54, 0.9);
        color: white;
        font-size: 13px;
        z-index: 200;
        display: none;
      }
      
      .error-banner.visible {
        display: block;
      }
      
      /* Error state dimming overlay for 3D scene */
      .error-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        pointer-events: none; /* Allow clicks to pass through to 3D scene */
        z-index: 50;
        display: none;
        border: 3px solid rgba(244, 67, 54, 0.6);
        box-sizing: border-box;
      }
      
      .error-overlay.visible {
        display: block;
      }
      
      .error-overlay::after {
        content: 'Viewing stale geometry';
        position: absolute;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(244, 67, 54, 0.85);
        color: white;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
      }
      
      /* Wall selection hint decoration */
      .wall-selection-hint {
        color: #4a9eff;
        font-style: italic;
        margin-left: 8px;
        opacity: 0.9;
      }
      
      /* Multi-selection highlighting in editor (for 3D multi-select ‚Üí editor sync) */
      .selected-entity-decoration {
        background-color: rgba(0, 255, 0, 0.15);
        border-radius: 2px;
      }
      
      /* Properties Panel */
      .properties-panel {
        position: absolute;
        top: 16px;
        left: 16px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 8px;
        min-width: 220px;
        max-width: 280px;
        z-index: 100;
        border: 1px solid #333;
        display: none;
      }
      
      .properties-panel-content {
        padding: 12px;
      }
      
      .properties-panel-title {
        font-size: 14px;
        font-weight: 600;
        color: #fff;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #444;
      }
      
      .properties-panel-form {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      
      .property-row {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .property-label {
        flex: 0 0 80px;
        font-size: 12px;
        color: #999;
      }
      
      .property-input {
        flex: 1;
        background: #333;
        border: 1px solid #555;
        border-radius: 4px;
        padding: 4px 8px;
        color: #fff;
        font-size: 12px;
        min-width: 0;
      }
      
      .property-input:focus {
        outline: none;
        border-color: #4a9eff;
      }
      
      .property-value.readonly {
        flex: 1;
        color: #888;
        font-size: 12px;
      }
      
      .properties-panel-note {
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px solid #444;
        font-size: 11px;
        color: #666;
        font-style: italic;
      }
      
      .properties-panel-actions {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #444;
        display: flex;
        justify-content: flex-end;
      }
      
      .delete-btn {
        background: #5a2d2d;
        border: 1px solid #8a4a4a;
        color: #f88;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
      }
      
      .delete-btn:hover {
        background: #6a3a3a;
        border-color: #9a5a5a;
      }
      
      /* Confirm delete dialog */
      .confirm-dialog {
        background: #2d2d2d;
        border: 1px solid #555;
        border-radius: 8px;
        padding: 20px;
        min-width: 320px;
        max-width: 420px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      }
      
      .confirm-dialog-title {
        font-size: 16px;
        font-weight: 600;
        color: #f88;
        margin-bottom: 12px;
      }
      
      .confirm-dialog-message {
        font-size: 13px;
        color: #ccc;
        margin-bottom: 12px;
        line-height: 1.5;
      }
      
      .confirm-dialog-warning {
        background: rgba(244, 136, 136, 0.15);
        border: 1px solid rgba(244, 136, 136, 0.3);
        border-radius: 4px;
        padding: 10px;
        margin-bottom: 16px;
      }
      
      .confirm-dialog-warning-title {
        font-size: 12px;
        font-weight: 600;
        color: #f88;
        margin-bottom: 6px;
      }
      
      .confirm-dialog-warning-list {
        font-size: 11px;
        color: #ccc;
        margin: 0;
        padding-left: 16px;
      }
      
      .confirm-dialog-warning-list li {
        margin-bottom: 2px;
      }
      
      /* Keyboard Help Overlay */
      #keyboard-help-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 500;
        display: none;
        justify-content: center;
        align-items: center;
      }
      
      .keyboard-help-content {
        background: #2d2d2d;
        border: 1px solid #555;
        border-radius: 12px;
        padding: 24px 32px;
        max-width: 700px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.4);
      }
      
      .keyboard-help-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #444;
      }
      
      .keyboard-help-title {
        font-size: 18px;
        font-weight: 600;
        color: #fff;
      }
      
      .keyboard-help-close {
        background: none;
        border: none;
        color: #888;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
      }
      
      .keyboard-help-close:hover {
        color: #fff;
      }
      
      .keyboard-help-columns {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
      }
      
      .keyboard-help-section {
        margin-bottom: 16px;
      }
      
      .keyboard-help-section-title {
        font-size: 12px;
        font-weight: 600;
        color: #4a9eff;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
      }
      
      .keyboard-help-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
      }
      
      .keyboard-help-row .keys {
        display: flex;
        gap: 4px;
      }
      
      .keyboard-help-row .key {
        display: inline-block;
        background: #3c3c3c;
        padding: 3px 8px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        border: 1px solid #555;
        color: #fff;
      }
      
      .keyboard-help-row .key-desc {
        color: #aaa;
        font-size: 12px;
      }
      
      .keyboard-help-footer {
        margin-top: 20px;
        padding-top: 12px;
        border-top: 1px solid #444;
        text-align: center;
        color: #666;
        font-size: 11px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Editor Panel -->
      <div class="editor-panel" role="region" aria-label="Code Editor">
        <div class="editor-header">
          <h2>Floorplan DSL</h2>
          <div class="editor-header-right">
            <button class="add-room-btn" id="add-room-btn" aria-label="Add new room">Room</button>
            <div class="export-dropdown">
              <button class="export-btn" id="export-btn" aria-haspopup="menu" aria-expanded="false">Export</button>
              <div class="export-menu" id="export-menu">
                <button class="export-menu-item" data-format="dsl">
                  Floorplan DSL <span class="ext">.floorplan</span>
                </button>
                <button class="export-menu-item" data-format="json">
                  JSON Data <span class="ext">.json</span>
                </button>
                <div class="export-menu-divider"></div>
                <button class="export-menu-item" data-format="glb">
                  3D Model (Binary) <span class="ext">.glb</span>
                </button>
                <button class="export-menu-item" data-format="gltf">
                  3D Model (Text) <span class="ext">.gltf</span>
                </button>
              </div>
            </div>
            <span id="editor-status" class="editor-status">Ready</span>
          </div>
        </div>
        <div id="editor-container"></div>
      </div>
      
      <!-- Resizer -->
      <div class="resizer" id="resizer"></div>
      
      <!-- 3D Viewer Panel -->
      <div class="viewer-panel" role="region" aria-label="3D Viewer">
        <div class="error-banner" id="error-banner" role="alert" aria-live="polite"></div>
        <div class="error-overlay" id="error-overlay" aria-hidden="true"></div>
        <div id="app" role="application" aria-label="3D floorplan viewer"></div>
        
        <!-- Control Panel -->
        <div id="controls">
          <!-- Camera Section -->
          <div class="control-section">
            <div class="section-header">Camera</div>
            <div class="section-content">
              <button id="camera-mode-btn">Switch to Orthographic</button>
              <button id="isometric-btn" class="btn-secondary">Isometric View</button>
              <div class="control-group" id="fov-group">
                <div class="control-row">
                  <label>FOV</label>
                  <span class="slider-value" id="fov-value">75¬∞</span>
                </div>
                <input type="range" id="fov-slider" min="30" max="120" value="75" step="1">
              </div>
            </div>
          </div>
          
          <!-- Lighting Section -->
          <div class="control-section collapsed">
            <div class="section-header">Lighting</div>
            <div class="section-content">
              <div class="control-group">
                <div class="control-row">
                  <label>Azimuth</label>
                  <span class="slider-value" id="light-azimuth-value">45¬∞</span>
                </div>
                <input type="range" id="light-azimuth" min="0" max="360" value="45" step="1">
              </div>
              <div class="control-group">
                <div class="control-row">
                  <label>Elevation</label>
                  <span class="slider-value" id="light-elevation-value">60¬∞</span>
                </div>
                <input type="range" id="light-elevation" min="0" max="90" value="60" step="1">
              </div>
              <div class="control-group">
                <div class="control-row">
                  <label>Intensity</label>
                  <span class="slider-value" id="light-intensity-value">1.0</span>
                </div>
                <input type="range" id="light-intensity" min="0" max="2" value="1" step="0.1">
              </div>
            </div>
          </div>
          
          <!-- View Section -->
          <div class="control-section collapsed">
            <div class="section-header">View</div>
            <div class="section-content">
              <div class="control-group">
                <div class="control-row">
                  <label>Theme</label>
                  <button id="theme-toggle-btn" class="btn-secondary" style="padding: 4px 12px; font-size: 11px;">üåô Dark</button>
                </div>
              </div>
              <div class="control-group">
                <div class="control-row">
                  <label>Exploded View</label>
                  <span class="slider-value" id="exploded-value">0%</span>
                </div>
                <input type="range" id="exploded-view" min="0" max="100" value="0" step="1">
              </div>
            </div>
          </div>
          
          <!-- Floors Section -->
          <div class="control-section">
            <div class="section-header">Floors</div>
            <div class="section-content">
              <div id="floor-list" class="floor-list">
                <div class="no-floors-message">Floors will appear here</div>
              </div>
              <div class="floor-actions">
                <button id="show-all-floors" class="btn-secondary">Show All</button>
                <button id="hide-all-floors" class="btn-secondary">Hide All</button>
              </div>
            </div>
          </div>
          
          <!-- 2D Overlay Section -->
          <div class="control-section collapsed">
            <div class="section-header">2D Overlay</div>
            <div class="section-content">
              <div class="checkbox-row">
                <input type="checkbox" id="show-2d-overlay">
                <label for="show-2d-overlay">Show 2D Mini-map</label>
              </div>
              <div class="control-group">
                <div class="control-row">
                  <label>Opacity</label>
                  <span class="slider-value" id="overlay-opacity-value">60%</span>
                </div>
                <input type="range" id="overlay-opacity" min="20" max="100" value="60" step="5">
              </div>
            </div>
          </div>
          
          <!-- Annotations Section -->
          <div class="control-section collapsed">
            <div class="section-header">Annotations</div>
            <div class="section-content">
              <div class="checkbox-row">
                <input type="checkbox" id="show-area">
                <label for="show-area">Show Room Areas</label>
              </div>
              <div class="checkbox-row">
                <input type="checkbox" id="show-dimensions">
                <label for="show-dimensions">Show Dimensions</label>
              </div>
              <div class="checkbox-row">
                <input type="checkbox" id="show-floor-summary">
                <label for="show-floor-summary">Show Floor Summary</label>
              </div>
              <div class="unit-row">
                <label>Area Unit</label>
                <select id="area-unit">
                  <option value="sqft">sq ft</option>
                  <option value="sqm">sq m</option>
                </select>
              </div>
              <div class="unit-row">
                <label>Length Unit</label>
                <select id="length-unit">
                  <option value="ft" selected>feet</option>
                  <option value="m">meters</option>
                  <option value="cm">centimeters</option>
                  <option value="in">inches</option>
                  <option value="mm">millimeters</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Selection Section -->
          <div class="control-section">
            <div class="section-header">Selection</div>
            <div class="section-content">
              <div class="checkbox-row">
                <input type="checkbox" id="selection-enabled" checked>
                <label for="selection-enabled">Enable Selection Mode</label>
              </div>
              <div id="selection-status" style="margin: 8px 0; padding: 6px 10px; background: rgba(0, 255, 0, 0.15); border: 1px solid rgba(0, 255, 0, 0.4); border-radius: 4px; font-size: 11px; color: #0f0;">
                ‚úì Selection Mode Active (press V to toggle)
              </div>
              <div class="checkbox-row" style="margin-top: 8px;">
              <input type="checkbox" id="containment-mode">
                <label for="containment-mode">Containment mode</label>
            </div>
              <div class="control-row" style="margin-top: 8px;">
                <span style="font-size: 11px; color: #888;">Marquee mode:</span>
                <span class="slider-value" id="mode-indicator" style="color: #4a9eff;">Intersection</span>
          </div>
              <div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #444; font-size: 11px; color: #666;">
                Press <span class="key" style="margin: 0;">H</span> for shortcuts
              </div>
            </div>
          </div>
        </div>
        
        <!-- 2D Overlay Mini-map Container -->
        <div id="overlay-2d">
          <div id="overlay-2d-header">
            <span>2D Floor Plan</span>
            <button id="overlay-2d-close" title="Close">√ó</button>
          </div>
          <div id="overlay-2d-content">
            <span id="overlay-2d-empty">2D view will appear here</span>
          </div>
          <div id="overlay-2d-resize"></div>
        </div>
        
        <!-- Floor Summary Panel -->
        <div id="floor-summary">
          <div class="floor-summary-title">Floor Summary</div>
          <div id="floor-summary-content"></div>
        </div>
        
        <div id="selection-info" class="selection-info" role="status" aria-live="polite" aria-label="Selection status">
          <div class="details">No selection</div>
        </div>
        
        <!-- Properties Panel (shown when single element selected) -->
        <div id="properties-panel" class="properties-panel" role="complementary" aria-label="Properties panel"></div>
      </div>
    </div>
    
    <!-- Delete Confirm Dialog -->
    <div class="dialog-overlay" id="delete-confirm-dialog">
      <div class="confirm-dialog">
        <div class="confirm-dialog-title">Delete <span id="delete-entity-name"></span>?</div>
        <div class="confirm-dialog-message" id="delete-message"></div>
        <div class="confirm-dialog-warning" id="delete-warning" style="display: none;">
          <div class="confirm-dialog-warning-title">‚ö†Ô∏è This will also delete:</div>
          <ul class="confirm-dialog-warning-list" id="delete-cascade-list"></ul>
        </div>
        <div class="dialog-buttons">
          <button class="dialog-btn cancel" id="delete-cancel">Cancel</button>
          <button class="dialog-btn primary" id="delete-confirm" style="background: #5a2d2d; border-color: #8a4a4a; color: #f88;">Delete</button>
        </div>
      </div>
    </div>
    
    <!-- Keyboard Help Overlay -->
    <div id="keyboard-help-overlay" role="dialog" aria-label="Keyboard shortcuts" aria-modal="true">
      <div class="keyboard-help-content">
        <div class="keyboard-help-header">
          <h2 class="keyboard-help-title">Keyboard Shortcuts</h2>
          <button class="keyboard-help-close" aria-label="Close">&times;</button>
        </div>
        <div class="keyboard-help-columns">
          <div>
            <div class="keyboard-help-section">
              <div class="keyboard-help-section-title">Navigation</div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span></div>
                <span class="key-desc">Pan camera</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">Q</span><span class="key">E</span></div>
                <span class="key-desc">Move down / up</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">+</span><span class="key">-</span></div>
                <span class="key-desc">Zoom in / out</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">Shift</span></div>
                <span class="key-desc">Precision mode</span>
              </div>
            </div>
            <div class="keyboard-help-section">
              <div class="keyboard-help-section-title">Views</div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">1</span></div>
                <span class="key-desc">Front view</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">3</span></div>
                <span class="key-desc">Right view</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">7</span></div>
                <span class="key-desc">Top view</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">5</span></div>
                <span class="key-desc">Toggle ortho/perspective</span>
              </div>
            </div>
          </div>
          <div>
            <div class="keyboard-help-section">
              <div class="keyboard-help-section-title">Camera</div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">Home</span></div>
                <span class="key-desc">Reset camera</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">F</span></div>
                <span class="key-desc">Frame geometry</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">C</span></div>
                <span class="key-desc">Center pivot</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">P</span></div>
                <span class="key-desc">Toggle pivot indicator</span>
              </div>
            </div>
            <div class="keyboard-help-section">
              <div class="keyboard-help-section-title">Selection</div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">Click</span></div>
                <span class="key-desc">Select</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">Shift</span><span class="key">Click</span></div>
                <span class="key-desc">Add to selection</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">‚åò/Ctrl</span><span class="key">A</span></div>
                <span class="key-desc">Select all</span>
              </div>
              <div class="keyboard-help-row">
                <div class="keys"><span class="key">Esc</span></div>
                <span class="key-desc">Deselect</span>
              </div>
            </div>
          </div>
        </div>
        <div class="keyboard-help-footer">
          Press <span class="key" style="background:#333;padding:2px 6px;">H</span> or <span class="key" style="background:#333;padding:2px 6px;">?</span> to toggle this help
        </div>
      </div>
    </div>
    
    <!-- Add Room Dialog -->
    <div class="dialog-overlay" id="add-room-dialog">
      <div class="dialog">
        <div class="dialog-title">Add New Room</div>
        <div class="dialog-field">
          <label for="room-name">Room Name</label>
          <input type="text" id="room-name" placeholder="e.g., Bedroom, Office" autocomplete="off">
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label for="room-x">X Position</label>
            <input type="number" id="room-x" value="0" step="0.5">
          </div>
          <div class="dialog-field">
            <label for="room-y">Y Position</label>
            <input type="number" id="room-y" value="0" step="0.5">
          </div>
        </div>
        <div class="dialog-row">
          <div class="dialog-field">
            <label for="room-width">Width</label>
            <input type="number" id="room-width" value="4" step="0.5" min="0.5">
          </div>
          <div class="dialog-field">
            <label for="room-height">Height</label>
            <input type="number" id="room-height" value="4" step="0.5" min="0.5">
          </div>
        </div>
        <div class="dialog-error" id="add-room-error"></div>
        <div class="dialog-buttons">
          <button class="dialog-btn cancel" id="add-room-cancel">Cancel</button>
          <button class="dialog-btn primary" id="add-room-confirm">Add Room</button>
        </div>
      </div>
    </div>
    
    <script type="module">
      import { InteractiveEditor } from './src/interactive-editor.ts';
      import { createDslEditor } from './src/dsl-editor.ts';
      import { EditorViewerSync } from './src/editor-viewer-sync.ts';
      import { PropertiesPanel } from './src/properties-panel.ts';
      import { dslPropertyEditor, dslGenerator } from './src/dsl-generator.ts';
      import { Overlay2DManager, createValidationWarningsUI } from 'viewer-core';
      import { EmptyFileSystem, URI } from 'langium';
      import { createFloorplansServices, convertFloorplanToJson } from 'floorplans-language';
      
      // Sample DSL content
      const sampleDsl = `floorplan
  config {
    default_height: 2.8,
    wall_thickness: 0.15,
    floor_thickness: 0.1
  }
  
  floor GroundFloor {
    room LivingRoom at (0, 0) size (8 x 6) walls [top: solid, right: solid, bottom: solid, left: solid]
    room Kitchen at (8.5, 0) size (5 x 6) walls [top: solid, right: solid, bottom: solid, left: open]
    room DiningRoom at (14, 0) size (5 x 6) walls [top: solid, right: solid, bottom: solid, left: solid]
    room Bedroom at (0, 7) size (6 x 5) walls [top: solid, right: solid, bottom: solid, left: solid]
    room Bathroom at (6.5, 7) size (4 x 5) walls [top: solid, right: solid, bottom: solid, left: solid]
    room Office at (11, 7) size (5 x 5) walls [top: solid, right: solid, bottom: solid, left: solid]
  }
  
  connect LivingRoom.right to Kitchen.left door at 50%
  connect Kitchen.right to DiningRoom.left door at 50%
`;
      
      // Initialize Langium services
      const services = createFloorplansServices(EmptyFileSystem);
      const parser = services.Floorplans.parser.LangiumParser;
      
      // Create Langium document for 2D rendering
      let documentId = 1;
      async function createLangiumDocument(input) {
        const uri = URI.parse(`file:///floorplan-${documentId++}.fp`);
        const document = services.shared.workspace.LangiumDocumentFactory.fromString(input, uri);
        services.shared.workspace.LangiumDocuments.addDocument(document);
        await services.shared.workspace.DocumentBuilder.build([document]);
        return document;
      }
      
      // State
      let currentJsonData = null;
      let currentLangiumDoc = null;
      let editorSync = null;
      let parseDebounceTimeout = null;
      
      // Create DSL editor
      const dslEditor = createDslEditor({
        containerId: 'editor-container',
        initialContent: sampleDsl,
        theme: 'vs-dark',
        fontSize: 13,
        onChange: (content) => {
          // Debounce parsing
          if (parseDebounceTimeout) {
            clearTimeout(parseDebounceTimeout);
          }
          parseDebounceTimeout = setTimeout(() => {
            parseAndUpdate(content);
          }, 300);
        },
      });
      
      // Create 3D editor (initially with sample data)
      const editor3d = new InteractiveEditor({
        containerId: 'app',
        enableSelection: true,
      });
      
      // Create 2D overlay manager (uses viewer-core shared implementation)
      const overlay2DManager = new Overlay2DManager({
        getCurrentTheme: () => 'dark', // Editor always uses dark theme
        getFloorplanData: () => currentJsonData,
        getVisibleFloorIds: () => editor3d.floorManager?.getVisibleFloorIds() ?? [],
      });
      overlay2DManager.setupControls();
      
      // Create validation warnings panel (uses viewer-core shared implementation)
      const validationWarningsUI = createValidationWarningsUI({
        left: '10px',   // Position left (editor has different layout than viewer)
        top: '60px',    // Below the viewer panel header
        startCollapsed: true,
        onWarningClick: (warning) => {
          // Navigate to warning line in editor
          if (warning.line && dslEditor) {
            dslEditor.goToLine(warning.line, warning.column || 1);
          }
        },
      });
      // Append to viewer panel (not body, since editor has split layout)
      document.querySelector('.viewer-panel')?.appendChild(validationWarningsUI.element);
      
      // UI elements
      const editorStatus = document.getElementById('editor-status');
      const errorBanner = document.getElementById('error-banner');
      const errorOverlay = document.getElementById('error-overlay');
      const selectionInfo = document.getElementById('selection-info');
      const containmentCheckbox = document.getElementById('containment-mode');
      const modeIndicator = document.getElementById('mode-indicator');
      
      /**
       * Parse DSL and update 3D view
       */
      async function parseAndUpdate(content) {
        try {
          // Parse the DSL
          const parseResult = parser.parse(content);
          
          if (parseResult.lexerErrors.length > 0 || parseResult.parserErrors.length > 0) {
            const errors = [
              ...parseResult.lexerErrors.map(e => ({
                line: e.line ?? 1,
                column: e.column ?? 1,
                message: e.message,
              })),
              ...parseResult.parserErrors.map(e => ({
                line: e.token?.startLine ?? 1,
                column: e.token?.startColumn ?? 1,
                message: e.message,
              })),
            ];
            
            showError(errors[0].message);
            dslEditor.setErrorMarkers(errors);
            editorStatus.textContent = `${errors.length} error(s)`;
            editorStatus.className = 'editor-status error';
            // Set error state (3D view keeps last valid geometry)
            editor3d.setErrorState(true);
            // Clear warnings on parse error
            validationWarningsUI.clear();
            return;
          }
          
          // Convert to JSON
          const conversionResult = convertFloorplanToJson(parseResult.value);
          
          if (conversionResult.errors.length > 0) {
            showError(conversionResult.errors[0].message);
            editorStatus.textContent = 'Conversion error';
            editorStatus.className = 'editor-status error';
            // Set error state (3D view keeps last valid geometry)
            editor3d.setErrorState(true);
            // Clear warnings on conversion error
            validationWarningsUI.clear();
            return;
          }
          
          // Success - update 3D view
          currentJsonData = conversionResult.data;
          editor3d.loadFloorplan(currentJsonData);
          
          // Create Langium document for 2D overlay rendering and validation
          try {
            currentLangiumDoc = await createLangiumDocument(content);
            overlay2DManager.setLangiumDocument(currentLangiumDoc);
            
            // Run validation and collect warnings
            const validationDiagnostics = await services.Floorplans.validation.DocumentValidator.validateDocument(currentLangiumDoc);
            const warnings = validationDiagnostics
              .filter(diag => diag.severity === 2) // severity 2 = Warning
              .map(diag => ({
                message: diag.message,
                line: diag.range ? diag.range.start.line + 1 : undefined,
                column: diag.range ? diag.range.start.character + 1 : undefined,
              }));
            
            // Update validation warnings panel
            validationWarningsUI.update(warnings);
            
            // Log warnings to console for debugging
            if (warnings.length > 0) {
              console.warn('‚ö†Ô∏è Validation warnings:');
              for (const w of warnings) {
                const lineInfo = w.line ? ` (line ${w.line})` : '';
                console.warn(`  ‚ö† ${w.message}${lineInfo}`);
              }
            }
          } catch (docErr) {
            console.warn('Failed to create Langium document for 2D overlay:', docErr);
            currentLangiumDoc = null;
            overlay2DManager.setLangiumDocument(null);
            validationWarningsUI.clear();
          }
          
          // Update entity locations for sync
          if (editorSync) {
            const entityLocations = extractEntityLocations(currentJsonData);
            editorSync.updateEntityLocations(entityLocations);
          }
          
          // Clear errors (loadFloorplan already clears error state)
          hideError();
          dslEditor.clearErrorMarkers();
          editorStatus.textContent = 'Ready';
          editorStatus.className = 'editor-status success';
          
        } catch (err) {
          showError(err.message);
          editorStatus.textContent = 'Parse error';
          editorStatus.className = 'editor-status error';
          // Set error state (3D view keeps last valid geometry)
          editor3d.setErrorState(true);
          // Clear warnings on error
          validationWarningsUI.clear();
        }
      }
      
      
      /**
       * Extract entity locations from JSON for editor sync
       */
      function extractEntityLocations(jsonData) {
        const locations = [];
        
        for (const floor of jsonData.floors) {
          for (const room of floor.rooms) {
            if (room._sourceRange) {
              locations.push({
                entityType: 'room',
                entityId: room.name,
                floorId: floor.id,
                sourceRange: room._sourceRange,
              });
            }
            
            // Extract wall locations for wall direction ‚Üí 3D highlight sync
            for (const wall of room.walls || []) {
              if (wall._sourceRange) {
                locations.push({
                  entityType: 'wall',
                  entityId: `${room.name}_${wall.direction}`,
                  floorId: floor.id,
                  sourceRange: wall._sourceRange,
                });
              }
            }
          }
        }
        
        for (const conn of jsonData.connections) {
          if (conn._sourceRange) {
            locations.push({
              entityType: 'connection',
              entityId: `${conn.fromRoom}-${conn.toRoom}`,
              floorId: jsonData.floors[0]?.id ?? 'default',
              sourceRange: conn._sourceRange,
            });
          }
        }
        
        return locations;
      }
      
      /**
       * Show error in banner and dim 3D scene
       */
      function showError(message) {
        errorBanner.textContent = message;
        errorBanner.classList.add('visible');
        errorOverlay.classList.add('visible');
      }
      
      /**
       * Hide error banner and clear 3D scene dimming
       */
      function hideError() {
        errorBanner.classList.remove('visible');
        errorOverlay.classList.remove('visible');
      }
      
      /**
       * Update selection info display
       */
      function updateSelectionInfo(selection) {
        const count = selection.size;
        
        if (count === 0) {
          selectionInfo.innerHTML = '<div class="details">No selection</div>';
          selectionInfo.classList.remove('has-selection');
          selectionInfo.classList.remove('visible');
        } else {
          const types = new Map();
          for (const obj of selection) {
            types.set(obj.entityType, (types.get(obj.entityType) || 0) + 1);
          }
          
          const summary = Array.from(types.entries())
            .map(([type, cnt]) => `${cnt} ${type}${cnt > 1 ? 's' : ''}`)
            .join(', ');
          
          let names = '';
          if (count <= 3) {
            names = Array.from(selection).map(s => s.entityId).join(', ');
          }
          
          selectionInfo.innerHTML = `
            <div class="count">${count}</div>
            <div class="details">${summary}</div>
            ${names ? `<div class="details" style="margin-top: 4px; color: #00ff00;">${names}</div>` : ''}
          `;
          selectionInfo.classList.add('has-selection');
          selectionInfo.classList.add('visible');
        }
      }
      
      // Setup selection manager listeners
      if (editor3d.selectionManager) {
        editor3d.selectionManager.onSelectionChange((event) => {
          updateSelectionInfo(event.selection);
          updatePropertiesPanel(event.selection);
        });
        
        // Enter key focuses properties panel
        editor3d.selectionManager.onEnterPressed(() => {
          const propertiesPanelEl = document.getElementById('properties-panel');
          if (propertiesPanelEl && propertiesPanelEl.style.display !== 'none') {
            // Focus first input in properties panel
            const firstInput = propertiesPanelEl.querySelector('input, select');
            if (firstInput instanceof HTMLElement) {
              firstInput.focus();
            }
          }
        });
        
        // Setup bidirectional sync
        editorSync = new EditorViewerSync(
          dslEditor.editor,
          editor3d.selectionManager,
          { debug: false }
        );
        
        // Handle editor cursor ‚Üí 3D selection (supports multi-cursor)
        editorSync.onEditorSelect((entityKey, isAdditive) => {
          // Parse the key: floorId:entityType:entityId
          const parts = entityKey.split(':');
          if (parts.length !== 3) return;
          
          const [floorId, entityType, entityId] = parts;
          
          // Find the entity in the registry and select it
          const registry = editor3d.meshRegistry;
          const entities = registry.getAllEntities();
          
          for (const entity of entities) {
            if (entity.floorId === floorId && 
                entity.entityType === entityType && 
                entity.entityId === entityId) {
              // Use isAdditive for multi-cursor support
              editor3d.selectionManager.select(entity, isAdditive);
              break;
            }
          }
        });
        
        // Handle editor text highlight ‚Üí 3D preview highlight
        editorSync.onEditorHighlight((entityKeys) => {
          // Clear existing highlights first
          editor3d.selectionManager.clearHighlight();
          
          const registry = editor3d.meshRegistry;
          const entities = registry.getAllEntities();
          
          for (const entityKey of entityKeys) {
            const parts = entityKey.split(':');
            if (parts.length !== 3) continue;
            
            const [floorId, entityType, entityId] = parts;
            
            for (const entity of entities) {
              if (entity.floorId === floorId && 
                  entity.entityType === entityType && 
                  entity.entityId === entityId) {
                // Highlight (preview) without selecting
                editor3d.selectionManager.highlight(entity);
                break;
              }
            }
          }
        });
        
        // Handle clear highlight when text selection is cleared
        editorSync.onEditorHighlightClear(() => {
          editor3d.selectionManager.clearHighlight();
        });
      }
      
      // Properties Panel
      const propertiesPanel = new PropertiesPanel({
        container: 'properties-panel',
        onPropertyChange: (event) => {
          console.log('Property changed:', event);
          
          // Generate Monaco edit operation
          const sourceText = dslEditor.getValue();
          
          if (!event.sourceRange) {
            console.warn('Cannot edit: no source range available');
            return;
          }
          
          let editOp = null;
          
          if (event.entityType === 'room') {
            editOp = dslPropertyEditor.generateRoomPropertyEdit(
              sourceText,
              event.sourceRange,
              event.property,
              event.newValue
            );
          } else if (event.entityType === 'wall') {
            editOp = dslPropertyEditor.generateWallPropertyEdit(
              sourceText,
              event.sourceRange,
              event.property,
              event.newValue
            );
          } else if (event.entityType === 'connection') {
            editOp = dslPropertyEditor.generateConnectionPropertyEdit(
              sourceText,
              event.sourceRange,
              event.property,
              event.newValue
            );
          }
          
          if (editOp) {
            // Apply the edit using Monaco's executeEdits
            const monacoEditor = dslEditor.editor;
            const model = monacoEditor.getModel();
            
            if (model) {
              // Use pushEditOperations to support undo
              model.pushEditOperations(
                [], // No selections to preserve
                [{
                  range: {
                    startLineNumber: editOp.range.startLineNumber,
                    startColumn: editOp.range.startColumn,
                    endLineNumber: editOp.range.endLineNumber,
                    endColumn: editOp.range.endColumn,
                  },
                  text: editOp.text,
                }],
                () => null // Don't change cursor position
              );
              
              console.log(`Applied edit: ${event.property} = ${event.newValue}`);
            }
          } else {
            console.warn(`Could not generate edit for ${event.entityType}.${event.property}`);
          }
        },
        onDelete: (event) => {
          console.log('Delete requested:', event);
          showDeleteConfirmation(event);
        },
      });
      
      // Show/hide properties panel based on selection
      function updatePropertiesPanel(selection) {
        if (selection.size === 1) {
          // Single selection - show properties panel
          const entity = Array.from(selection)[0];
          
          // Get entity data from JSON
          let entityData = {};
          if (currentJsonData) {
            if (entity.entityType === 'room') {
              for (const floor of currentJsonData.floors) {
                const room = floor.rooms.find(r => r.name === entity.entityId);
                if (room) {
                  entityData = {
                    name: room.name,
                    x: room.x,
                    y: room.z, // Note: z is the Y in 2D
                    width: room.width,
                    height: room.height,
                    roomHeight: room.roomHeight,
                    style: room.style,
                  };
                  break;
                }
              }
            } else if (entity.entityType === 'wall') {
              // Parse wall entity ID (e.g., "Kitchen_top")
              const match = entity.entityId.match(/^(.+)_(top|bottom|left|right)$/);
              if (match) {
                entityData = {
                  room: match[1],
                  direction: match[2],
                  type: 'solid', // Would need to look up actual type
                };
              }
            } else if (entity.entityType === 'connection') {
              // Parse connection entity ID (e.g., "LivingRoom-Kitchen")
              const parts = entity.entityId.split('-');
              if (parts.length >= 2) {
                const conn = currentJsonData.connections?.find(
                  c => c.fromRoom === parts[0] && c.toRoom === parts.slice(1).join('-')
                );
                entityData = {
                  fromRoom: parts[0],
                  toRoom: parts.slice(1).join('-'),
                  type: conn?.doorType ?? 'door',
                  position: conn?.position ?? 50,
                };
              }
            }
          }
          
          propertiesPanel.show(entity, entityData);
        } else {
          // Multiple or no selection - hide properties panel
          propertiesPanel.hide();
        }
      }
      
      // Mode toggle
      containmentCheckbox.addEventListener('change', (e) => {
        const mode = e.target.checked ? 'containment' : 'intersection';
        editor3d.setMarqueeMode(mode);
        modeIndicator.textContent = mode === 'containment' ? 'Containment' : 'Intersection';
        modeIndicator.style.color = mode === 'containment' ? '#ff9500' : '#4a9eff';
      });
      
      // Selection mode toggle
      const selectionEnabledCheckbox = document.getElementById('selection-enabled');
      const selectionStatus = document.getElementById('selection-status');
      
      function updateSelectionModeUI(enabled) {
        selectionEnabledCheckbox.checked = enabled;
        if (enabled) {
          selectionStatus.textContent = '‚úì Selection Mode Active (press V to toggle)';
          selectionStatus.style.background = 'rgba(0, 255, 0, 0.15)';
          selectionStatus.style.borderColor = 'rgba(0, 255, 0, 0.4)';
          selectionStatus.style.color = '#0f0';
        } else {
          selectionStatus.textContent = '‚úó Selection Mode Off (press V to toggle)';
          selectionStatus.style.background = 'rgba(255, 100, 0, 0.15)';
          selectionStatus.style.borderColor = 'rgba(255, 100, 0, 0.4)';
          selectionStatus.style.color = '#f60';
        }
      }
      
      selectionEnabledCheckbox.addEventListener('change', (e) => {
        const enabled = e.target.checked;
        if (editor3d.selectionManager) {
          editor3d.selectionManager.setEnabled(enabled);
        }
        updateSelectionModeUI(enabled);
      });
      
      // Listen for mode changes from keyboard (V key)
      if (editor3d.selectionManager) {
        editor3d.selectionManager.onModeChange((enabled) => {
          updateSelectionModeUI(enabled);
        });
      }
      
      // Initialize mode from saved preference
      try {
        const savedMode = localStorage.getItem('floorplan-marquee-mode');
        if (savedMode === 'containment') {
          containmentCheckbox.checked = true;
          editor3d.setMarqueeMode('containment');
          modeIndicator.textContent = 'Containment';
          modeIndicator.style.color = '#ff9500';
        }
      } catch (e) {}
      
      // ========================================
      // Control Panel Wiring
      // ========================================
      
      // Section collapse/expand
      document.querySelectorAll('.section-header').forEach(header => {
        header.addEventListener('click', () => {
          header.parentElement.classList.toggle('collapsed');
        });
      });
      
      // Camera controls
      const cameraModeBtn = document.getElementById('camera-mode-btn');
      const isometricBtn = document.getElementById('isometric-btn');
      const fovSlider = document.getElementById('fov-slider');
      const fovValue = document.getElementById('fov-value');
      const fovGroup = document.getElementById('fov-group');
      
      cameraModeBtn.addEventListener('click', () => {
        editor3d.cameraManager.toggleCameraMode();
        const mode = editor3d.cameraManager.getMode();
        cameraModeBtn.textContent = mode === 'perspective' ? 'Switch to Orthographic' : 'Switch to Perspective';
        fovGroup.style.display = mode === 'perspective' ? '' : 'none';
      });
      
      isometricBtn.addEventListener('click', () => {
        editor3d.cameraManager.setIsometricView();
      });
      
      fovSlider.addEventListener('input', () => {
        const fov = parseInt(fovSlider.value);
        fovValue.textContent = `${fov}¬∞`;
        if (editor3d.perspectiveCamera) {
          editor3d.perspectiveCamera.fov = fov;
          editor3d.perspectiveCamera.updateProjectionMatrix();
        }
      });
      
      // Lighting controls
      const lightAzimuth = document.getElementById('light-azimuth');
      const lightAzimuthValue = document.getElementById('light-azimuth-value');
      const lightElevation = document.getElementById('light-elevation');
      const lightElevationValue = document.getElementById('light-elevation-value');
      const lightIntensity = document.getElementById('light-intensity');
      const lightIntensityValue = document.getElementById('light-intensity-value');
      
      function updateLightPosition() {
        const azimuth = parseFloat(lightAzimuth.value) * Math.PI / 180;
        const elevation = parseFloat(lightElevation.value) * Math.PI / 180;
        const distance = 20;
        
        const x = distance * Math.cos(elevation) * Math.sin(azimuth);
        const y = distance * Math.sin(elevation);
        const z = distance * Math.cos(elevation) * Math.cos(azimuth);
        
        if (editor3d.directionalLight) {
          editor3d.directionalLight.position.set(x, y, z);
        }
      }
      
      lightAzimuth.addEventListener('input', () => {
        lightAzimuthValue.textContent = `${lightAzimuth.value}¬∞`;
        updateLightPosition();
      });
      
      lightElevation.addEventListener('input', () => {
        lightElevationValue.textContent = `${lightElevation.value}¬∞`;
        updateLightPosition();
      });
      
      lightIntensity.addEventListener('input', () => {
        const intensity = parseFloat(lightIntensity.value);
        lightIntensityValue.textContent = intensity.toFixed(1);
        if (editor3d.directionalLight) {
          editor3d.directionalLight.intensity = intensity;
        }
      });
      
      // View controls - Theme toggle
      const themeToggleBtn = document.getElementById('theme-toggle-btn');
      let currentTheme = 'dark';
      
      themeToggleBtn.addEventListener('click', () => {
        currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.classList.toggle('dark-theme', currentTheme === 'dark');
        editor3d.setTheme(currentTheme);
        themeToggleBtn.textContent = currentTheme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';
        overlay2DManager.render(); // Re-render 2D overlay with new theme
      });
      
      // Exploded view
      const explodedView = document.getElementById('exploded-view');
      const explodedValue = document.getElementById('exploded-value');
      
      explodedView.addEventListener('input', () => {
        const value = parseInt(explodedView.value);
        explodedValue.textContent = `${value}%`;
        editor3d.setExplodedView(value / 100);
      });
      
      // Floor visibility controls
      const floorList = document.getElementById('floor-list');
      const showAllFloorsBtn = document.getElementById('show-all-floors');
      const hideAllFloorsBtn = document.getElementById('hide-all-floors');
      
      function updateFloorListUI() {
        const floors = editor3d.floors;
        const floorManager = editor3d.floorManager;
        
        if (!floors || floors.length === 0) {
          floorList.innerHTML = '<div class="no-floors-message">Floors will appear here</div>';
          return;
        }
        
        floorList.innerHTML = '';
        floors.forEach((floor, index) => {
          const floorId = floor.name || `floor-${index}`;
          const visible = floorManager ? floorManager.getFloorVisibility(floorId) : true;
          
          const item = document.createElement('div');
          item.className = 'floor-item';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `floor-toggle-${index}`;
          checkbox.checked = visible;
          checkbox.addEventListener('change', () => {
            if (floorManager) {
              floorManager.setFloorVisible(floorId, checkbox.checked);
              overlay2DManager.render(); // Update 2D overlay
            }
          });
          
          const label = document.createElement('label');
          label.htmlFor = `floor-toggle-${index}`;
          label.textContent = floorId;
          
          item.appendChild(checkbox);
          item.appendChild(label);
          floorList.appendChild(item);
        });
      }
      
      showAllFloorsBtn.addEventListener('click', () => {
        if (editor3d.floorManager) {
          editor3d.floorManager.setAllFloorsVisible(true);
          updateFloorListUI();
          overlay2DManager.render(); // Update 2D overlay
        }
      });
      
      hideAllFloorsBtn.addEventListener('click', () => {
        if (editor3d.floorManager) {
          editor3d.floorManager.setAllFloorsVisible(false);
          updateFloorListUI();
          overlay2DManager.render(); // Update 2D overlay
        }
      });
      
      // 2D Overlay controls
      const show2dOverlay = document.getElementById('show-2d-overlay');
      const overlayOpacity = document.getElementById('overlay-opacity');
      const overlayOpacityValue = document.getElementById('overlay-opacity-value');
      const overlay2d = document.getElementById('overlay-2d');
      const overlay2dClose = document.getElementById('overlay-2d-close');
      
      show2dOverlay.addEventListener('change', () => {
        overlay2d.classList.toggle('visible', show2dOverlay.checked);
        if (show2dOverlay.checked) {
          overlay2DManager.render(); // Render when showing
        }
      });
      
      overlayOpacity.addEventListener('input', () => {
        const opacity = parseInt(overlayOpacity.value);
        overlayOpacityValue.textContent = `${opacity}%`;
        overlay2d.style.opacity = opacity / 100;
      });
      
      overlay2dClose.addEventListener('click', () => {
        overlay2d.classList.remove('visible');
        show2dOverlay.checked = false;
      });
      
      // 2D overlay drag functionality
      const overlay2dHeader = document.getElementById('overlay-2d-header');
      let isDraggingOverlay = false;
      let overlayDragStartX = 0;
      let overlayDragStartY = 0;
      let overlayInitialLeft = 0;
      let overlayInitialBottom = 0;
      
      overlay2dHeader.addEventListener('mousedown', (e) => {
        if (e.target === overlay2dClose) return;
        isDraggingOverlay = true;
        overlay2d.classList.add('dragging');
        overlayDragStartX = e.clientX;
        overlayDragStartY = e.clientY;
        const rect = overlay2d.getBoundingClientRect();
        overlayInitialLeft = rect.left;
        overlayInitialBottom = window.innerHeight - rect.bottom;
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isDraggingOverlay) return;
        const dx = e.clientX - overlayDragStartX;
        const dy = e.clientY - overlayDragStartY;
        overlay2d.style.left = `${overlayInitialLeft + dx}px`;
        overlay2d.style.bottom = `${overlayInitialBottom - dy}px`;
      });
      
      document.addEventListener('mouseup', () => {
        if (isDraggingOverlay) {
          isDraggingOverlay = false;
          overlay2d.classList.remove('dragging');
        }
      });
      
      // 2D overlay resize functionality
      const overlay2dResize = document.getElementById('overlay-2d-resize');
      let isResizingOverlay = false;
      let overlayResizeStartX = 0;
      let overlayResizeStartY = 0;
      let overlayInitialWidth = 0;
      let overlayInitialHeight = 0;
      
      overlay2dResize.addEventListener('mousedown', (e) => {
        isResizingOverlay = true;
        overlayResizeStartX = e.clientX;
        overlayResizeStartY = e.clientY;
        overlayInitialWidth = overlay2d.offsetWidth;
        overlayInitialHeight = overlay2d.offsetHeight;
        e.preventDefault();
        e.stopPropagation();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizingOverlay) return;
        const dx = e.clientX - overlayResizeStartX;
        const dy = e.clientY - overlayResizeStartY;
        overlay2d.style.width = `${Math.max(200, overlayInitialWidth + dx)}px`;
        overlay2d.style.height = `${Math.max(150, overlayInitialHeight + dy)}px`;
      });
      
      document.addEventListener('mouseup', () => {
        isResizingOverlay = false;
      });
      
      // Annotation controls
      const showArea = document.getElementById('show-area');
      const showDimensions = document.getElementById('show-dimensions');
      const showFloorSummary = document.getElementById('show-floor-summary');
      const areaUnit = document.getElementById('area-unit');
      const lengthUnit = document.getElementById('length-unit');
      const floorSummary = document.getElementById('floor-summary');
      
      function updateAnnotations() {
        if (editor3d.annotationManager) {
          // Directly update the annotation manager state
          editor3d.annotationManager.state.showArea = showArea.checked;
          editor3d.annotationManager.state.showDimensions = showDimensions.checked;
          editor3d.annotationManager.state.showFloorSummary = showFloorSummary.checked;
          editor3d.annotationManager.state.areaUnit = areaUnit.value;
          editor3d.annotationManager.state.lengthUnit = lengthUnit.value;
          editor3d.annotationManager.updateAll();
        }
      }
      
      showArea.addEventListener('change', updateAnnotations);
      showDimensions.addEventListener('change', updateAnnotations);
      
      showFloorSummary.addEventListener('change', () => {
        floorSummary.classList.toggle('visible', showFloorSummary.checked);
        updateAnnotations();
      });
      
      areaUnit.addEventListener('change', updateAnnotations);
      lengthUnit.addEventListener('change', updateAnnotations);
      
      // Update floor list when floorplan is loaded
      const originalLoadFloorplan = editor3d.loadFloorplan.bind(editor3d);
      editor3d.loadFloorplan = function(data) {
        originalLoadFloorplan(data);
        setTimeout(() => {
          updateFloorListUI();
        }, 100);
      };
      
      // ========================================
      // End Control Panel Wiring
      // ========================================
      
      // Resizer functionality
      const resizer = document.getElementById('resizer');
      const editorPanel = document.querySelector('.editor-panel');
      let isResizing = false;
      
      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        const newWidth = e.clientX;
        if (newWidth >= 200 && newWidth <= 800) {
          editorPanel.style.width = `${newWidth}px`;
        }
      });
      
      document.addEventListener('mouseup', () => {
        isResizing = false;
        document.body.style.cursor = '';
      });
      
      // Initial parse
      parseAndUpdate(sampleDsl);
      
      // Export functionality
      const exportBtn = document.getElementById('export-btn');
      const exportMenu = document.getElementById('export-menu');
      
      // Track filename for exports
      let currentFilename = 'floorplan';
      
      // Toggle export menu
      exportBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isOpen = exportMenu.classList.toggle('visible');
        exportBtn.setAttribute('aria-expanded', String(isOpen));
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', () => {
        exportMenu.classList.remove('visible');
        exportBtn.setAttribute('aria-expanded', 'false');
      });
      
      // Handle export menu items
      exportMenu.addEventListener('click', async (e) => {
        const item = e.target.closest('.export-menu-item');
        if (!item) return;
        
        const format = item.dataset.format;
        exportMenu.classList.remove('visible');
        
        try {
          switch (format) {
            case 'dsl':
              exportDsl();
              break;
            case 'json':
              exportJson();
              break;
            case 'glb':
              await exportGlb();
              break;
            case 'gltf':
              await exportGltf();
              break;
          }
        } catch (err) {
          console.error(`Export failed:`, err);
          alert(`Export failed: ${err.message}`);
        }
      });
      
      /**
       * Export DSL file
       */
      function exportDsl() {
        const content = dslEditor.getValue();
        downloadFile(`${currentFilename}.floorplan`, content, 'text/plain');
      }
      
      /**
       * Export JSON data
       */
      function exportJson() {
        if (!currentJsonData) {
          alert('No valid floorplan data to export. Fix parse errors first.');
          return;
        }
        
        // Create clean JSON without internal source ranges
        const cleanData = JSON.parse(JSON.stringify(currentJsonData));
        removeSourceRanges(cleanData);
        
        const content = JSON.stringify(cleanData, null, 2);
        downloadFile(`${currentFilename}.json`, content, 'application/json');
      }
      
      /**
       * Remove _sourceRange properties from object tree
       */
      function removeSourceRanges(obj) {
        if (Array.isArray(obj)) {
          obj.forEach(removeSourceRanges);
        } else if (obj && typeof obj === 'object') {
          delete obj._sourceRange;
          Object.values(obj).forEach(removeSourceRanges);
        }
      }
      
      /**
       * Export GLB (binary GLTF)
       */
      async function exportGlb() {
        const { GLTFExporter } = await import('three/examples/jsm/exporters/GLTFExporter.js');
        const exporter = new GLTFExporter();
        
        const scene = editor3d.scene;
        if (!scene) {
          alert('No 3D scene to export');
          return;
        }
        
        exporter.parse(
          scene,
          (result) => {
            // result is ArrayBuffer for binary
            const blob = new Blob([result], { type: 'application/octet-stream' });
            downloadBlob(`${currentFilename}.glb`, blob);
          },
          (error) => {
            console.error('GLB export error:', error);
            throw error;
          },
          { binary: true }
        );
      }
      
      /**
       * Export GLTF (text format)
       */
      async function exportGltf() {
        const { GLTFExporter } = await import('three/examples/jsm/exporters/GLTFExporter.js');
        const exporter = new GLTFExporter();
        
        const scene = editor3d.scene;
        if (!scene) {
          alert('No 3D scene to export');
          return;
        }
        
        exporter.parse(
          scene,
          (result) => {
            // result is JSON object for non-binary
            const content = JSON.stringify(result, null, 2);
            downloadFile(`${currentFilename}.gltf`, content, 'model/gltf+json');
          },
          (error) => {
            console.error('GLTF export error:', error);
            throw error;
          },
          { binary: false }
        );
      }
      
      /**
       * Download text content as file
       */
      function downloadFile(filename, content, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        downloadBlob(filename, blob);
      }
      
      /**
       * Download blob as file
       */
      function downloadBlob(filename, blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }
      
      // Add Room functionality
      const addRoomBtn = document.getElementById('add-room-btn');
      const addRoomDialog = document.getElementById('add-room-dialog');
      const addRoomCancel = document.getElementById('add-room-cancel');
      const addRoomConfirm = document.getElementById('add-room-confirm');
      const addRoomError = document.getElementById('add-room-error');
      const roomNameInput = document.getElementById('room-name');
      const roomXInput = document.getElementById('room-x');
      const roomYInput = document.getElementById('room-y');
      const roomWidthInput = document.getElementById('room-width');
      const roomHeightInput = document.getElementById('room-height');
      
      // Open dialog
      addRoomBtn.addEventListener('click', () => {
        // Reset form
        roomNameInput.value = '';
        roomXInput.value = '0';
        roomYInput.value = '0';
        roomWidthInput.value = '4';
        roomHeightInput.value = '4';
        addRoomError.classList.remove('visible');
        addRoomError.textContent = '';
        
        addRoomDialog.classList.add('visible');
        roomNameInput.focus();
      });
      
      // Close dialog
      addRoomCancel.addEventListener('click', () => {
        addRoomDialog.classList.remove('visible');
      });
      
      // Close on overlay click
      addRoomDialog.addEventListener('click', (e) => {
        if (e.target === addRoomDialog) {
          addRoomDialog.classList.remove('visible');
        }
      });
      
      // Close on Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && addRoomDialog.classList.contains('visible')) {
          addRoomDialog.classList.remove('visible');
        }
      });
      
      // Confirm add room
      addRoomConfirm.addEventListener('click', () => {
        addRoom();
      });
      
      // Enter key in form
      roomNameInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addRoom();
      });
      
      /**
       * Add a new room to the floorplan
       */
      function addRoom() {
        // Validate
        const name = roomNameInput.value.trim();
        if (!name) {
          showAddRoomError('Room name is required');
          roomNameInput.focus();
          return;
        }
        
        // Check for valid identifier (no spaces, start with letter)
        if (!/^[A-Za-z][A-Za-z0-9_]*$/.test(name)) {
          showAddRoomError('Room name must start with a letter and contain only letters, numbers, and underscores');
          roomNameInput.focus();
          return;
        }
        
        // Check for duplicate names
        if (currentJsonData) {
          const existingNames = new Set();
          for (const floor of currentJsonData.floors) {
            for (const room of floor.rooms) {
              existingNames.add(room.name);
            }
          }
          if (existingNames.has(name)) {
            showAddRoomError(`Room '${name}' already exists`);
            roomNameInput.focus();
            return;
          }
        }
        
        const x = parseFloat(roomXInput.value) || 0;
        const y = parseFloat(roomYInput.value) || 0;
        const width = parseFloat(roomWidthInput.value) || 4;
        const height = parseFloat(roomHeightInput.value) || 4;
        
        if (width < 0.5 || height < 0.5) {
          showAddRoomError('Width and height must be at least 0.5');
          return;
        }
        
        // Generate DSL
        const roomDsl = dslGenerator.generateRoom({
          name,
          x,
          y,
          width,
          height,
        });
        
        // Find insertion point (after last room in first floor)
        const insertPoint = findRoomInsertionPoint();
        if (!insertPoint) {
          showAddRoomError('Could not find floor block to add room');
          return;
        }
        
        // Insert the room DSL
        const model = dslEditor.editor.getModel();
        if (model) {
          model.pushEditOperations(
            [],
            [{
              range: {
                startLineNumber: insertPoint.line,
                startColumn: insertPoint.column,
                endLineNumber: insertPoint.line,
                endColumn: insertPoint.column,
              },
              text: '\n' + roomDsl,
            }],
            () => null
          );
        }
        
        // Close dialog
        addRoomDialog.classList.remove('visible');
      }
      
      /**
       * Find the line/column to insert a new room (after last room in first floor)
       */
      function findRoomInsertionPoint() {
        const content = dslEditor.getValue();
        const lines = content.split('\n');
        
        // Find the last room definition in the first floor
        let lastRoomLine = -1;
        let floorStarted = false;
        let floorIndent = 0;
        
        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];
          
          // Check for floor block start
          if (/^\s*floor\s+\S+/.test(line)) {
            floorStarted = true;
            floorIndent = line.match(/^(\s*)/)[1].length;
          }
          
          // Check for room definition
          if (floorStarted && /^\s*room\s+\S+/.test(line)) {
            lastRoomLine = i;
          }
          
          // Check for floor block end (closing brace at same indent)
          if (floorStarted && line.trim() === '}') {
            const braceIndent = line.match(/^(\s*)/)[1].length;
            if (braceIndent === floorIndent) {
              break; // End of first floor
            }
          }
        }
        
        if (lastRoomLine === -1) {
          // No rooms found, try to find after floor { line
          for (let i = 0; i < lines.length; i++) {
            if (/^\s*floor\s+\S+.*\{/.test(lines[i])) {
              return { line: i + 2, column: 1 }; // Line after floor {
            }
          }
          return null;
        }
        
        // Insert after the last room line
        return { line: lastRoomLine + 2, column: 1 }; // +2 because Monaco is 1-indexed and we want line after
      }
      
      /**
       * Show error in add room dialog
       */
      function showAddRoomError(message) {
        addRoomError.textContent = message;
        addRoomError.classList.add('visible');
      }
      
      // Delete functionality
      const deleteConfirmDialog = document.getElementById('delete-confirm-dialog');
      const deleteEntityName = document.getElementById('delete-entity-name');
      const deleteMessage = document.getElementById('delete-message');
      const deleteWarning = document.getElementById('delete-warning');
      const deleteCascadeList = document.getElementById('delete-cascade-list');
      const deleteCancel = document.getElementById('delete-cancel');
      const deleteConfirmBtn = document.getElementById('delete-confirm');
      
      let pendingDeleteEvent = null;
      let pendingCascadeConnections = [];
      
      /**
       * Show delete confirmation dialog
       */
      function showDeleteConfirmation(event) {
        pendingDeleteEvent = event;
        pendingCascadeConnections = [];
        
        // Set entity name
        deleteEntityName.textContent = `${event.entityType}: ${event.entityId}`;
        
        // Set message based on entity type
        if (event.entityType === 'room') {
          deleteMessage.textContent = `Are you sure you want to delete the room "${event.entityId}"?`;
          
          // Check for connections that reference this room
          if (currentJsonData && currentJsonData.connections) {
            const affectedConnections = currentJsonData.connections.filter(
              conn => conn.fromRoom === event.entityId || conn.toRoom === event.entityId
            );
            
            if (affectedConnections.length > 0) {
              pendingCascadeConnections = affectedConnections;
              deleteCascadeList.innerHTML = affectedConnections.map(
                conn => `<li>${conn.fromRoom} ‚Üí ${conn.toRoom} (${conn.doorType})</li>`
              ).join('');
              deleteWarning.style.display = 'block';
            } else {
              deleteWarning.style.display = 'none';
            }
          } else {
            deleteWarning.style.display = 'none';
          }
        } else if (event.entityType === 'wall') {
          // Walls can't be deleted, only changed to "open"
          const match = event.entityId.match(/^(.+)_(top|bottom|left|right)$/);
          const direction = match ? match[2] : 'wall';
          deleteMessage.textContent = `This will change the ${direction} wall to "open" (removing the wall). Continue?`;
          deleteWarning.style.display = 'none';
        } else if (event.entityType === 'connection') {
          deleteMessage.textContent = `Are you sure you want to delete this connection?`;
          deleteWarning.style.display = 'none';
        } else {
          deleteMessage.textContent = `Are you sure you want to delete "${event.entityId}"?`;
          deleteWarning.style.display = 'none';
        }
        
        deleteConfirmDialog.classList.add('visible');
      }
      
      // Close delete dialog
      deleteCancel.addEventListener('click', () => {
        deleteConfirmDialog.classList.remove('visible');
        pendingDeleteEvent = null;
        pendingCascadeConnections = [];
      });
      
      // Close on overlay click
      deleteConfirmDialog.addEventListener('click', (e) => {
        if (e.target === deleteConfirmDialog) {
          deleteConfirmDialog.classList.remove('visible');
          pendingDeleteEvent = null;
          pendingCascadeConnections = [];
        }
      });
      
      // Confirm delete
      deleteConfirmBtn.addEventListener('click', () => {
        if (pendingDeleteEvent) {
          executeDelete(pendingDeleteEvent, pendingCascadeConnections);
        }
        deleteConfirmDialog.classList.remove('visible');
        pendingDeleteEvent = null;
        pendingCascadeConnections = [];
      });
      
      /**
       * Execute delete operation
       */
      function executeDelete(event, cascadeConnections) {
        const model = dslEditor.editor.getModel();
        if (!model) return;
        
        // Handle wall "deletion" by changing type to "open"
        if (event.entityType === 'wall') {
          executeWallToOpen(event);
          return;
        }
        
        // Collect all ranges to delete (entity + cascade connections)
        const rangesToDelete = [];
        
        // Add main entity range
        if (event.sourceRange) {
          rangesToDelete.push({
            range: event.sourceRange,
            description: `${event.entityType}: ${event.entityId}`,
          });
        }
        
        // Add cascade connection ranges
        for (const conn of cascadeConnections) {
          if (conn._sourceRange) {
            rangesToDelete.push({
              range: conn._sourceRange,
              description: `connection: ${conn.fromRoom} ‚Üí ${conn.toRoom}`,
            });
          }
        }
        
        if (rangesToDelete.length === 0) {
          console.warn('No source ranges available for deletion');
          return;
        }
        
        // Sort ranges by position (end to start) to delete from bottom up
        // This prevents range shifting issues
        rangesToDelete.sort((a, b) => {
          if (a.range.endLine !== b.range.endLine) {
            return b.range.endLine - a.range.endLine;
          }
          return b.range.endColumn - a.range.endColumn;
        });
        
        // Build edit operations
        const edits = rangesToDelete.map(({ range }) => ({
          range: {
            startLineNumber: range.startLine + 1,
            startColumn: range.startColumn + 1,
            endLineNumber: range.endLine + 1,
            endColumn: range.endColumn + 2, // +2 to include trailing newline
          },
          text: '',
        }));
        
        // Apply all edits
        model.pushEditOperations([], edits, () => null);
        
        // Clear selection
        if (editor3d.selectionManager) {
          editor3d.selectionManager.deselect();
        }
        
        // Hide properties panel
        propertiesPanel.hide();
        
        console.log(`Deleted ${rangesToDelete.length} entities`);
      }
      
      /**
       * Change a wall type to "open" (wall "deletion")
       * Uses DslPropertyEditor for grammar-aware editing
       */
      function executeWallToOpen(event) {
        if (!event.sourceRange) {
          console.warn('No source range for wall');
          return;
        }
        
        const model = dslEditor.editor.getModel();
        if (!model) return;
        
        // Use DslPropertyEditor to generate the edit operation
        const sourceText = dslEditor.getValue();
        const editOp = dslPropertyEditor.generateWallPropertyEdit(
          sourceText,
          event.sourceRange,
          'type',
          'open'
        );
        
        if (!editOp) {
          console.warn('Could not generate wall type edit');
          return;
        }
        
        // Apply the edit
        model.pushEditOperations([], [{
          range: {
            startLineNumber: editOp.range.startLineNumber,
            startColumn: editOp.range.startColumn,
            endLineNumber: editOp.range.endLineNumber,
            endColumn: editOp.range.endColumn,
          },
          text: editOp.text,
        }], () => null);
        
        // Clear selection
        if (editor3d.selectionManager) {
          editor3d.selectionManager.deselect();
        }
        
        // Hide properties panel
        propertiesPanel.hide();
        
        console.log(`Changed wall to open: ${event.entityId}`);
      }
      
      // Keyboard help overlay close handlers
      const keyboardHelpOverlay = document.getElementById('keyboard-help-overlay');
      const keyboardHelpClose = keyboardHelpOverlay.querySelector('.keyboard-help-close');
      
      keyboardHelpClose.addEventListener('click', () => {
        keyboardHelpOverlay.style.display = 'none';
      });
      
      keyboardHelpOverlay.addEventListener('click', (e) => {
        if (e.target === keyboardHelpOverlay) {
          keyboardHelpOverlay.style.display = 'none';
        }
      });
      
      // Expose for debugging
      window.editor3d = editor3d;
      window.dslEditor = dslEditor;
      window.editorSync = editorSync;
      console.log('Interactive Editor with DSL sync initialized');
      console.log('Access: window.editor3d, window.dslEditor, window.editorSync');
    </script>
  </body>
</html>
