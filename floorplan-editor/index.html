<!DOCTYPE html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Interactive Floorplan Editor</title>
    <!-- CSS is imported via main.ts and processed by @tailwindcss/vite -->
    <style>
      /* Minimal base styles before Tailwind loads */
      #app {
        position: relative;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body class="bg-base-300">
    <!-- 3D Viewer Panel (full screen) -->
    <div class="absolute inset-0" role="region" aria-label="3D Viewer">
      <div id="app" role="application" aria-label="3D floorplan viewer"></div>
    </div>
    
    <!-- Editor Panel (collapsible overlay) - dynamically managed by EditorUI -->
    <!-- Note: fp-editor-panel class handles all transitions (top, height, transform) -->
    <div id="editor-panel" class="fp-editor-panel fixed left-0 w-[450px] min-w-[300px] max-w-[80vw] bg-base-200 flex flex-col z-[200] shadow-xl" role="region" aria-label="Code Editor">
      <button id="editor-panel-toggle" class="fp-editor-panel__collapse-btn" title="Collapse panel" aria-label="Toggle code editor panel">◀</button>
      <div id="editor-resize-handle" class="absolute top-0 -right-1.5 w-3 h-full cursor-ew-resize z-10"></div>
      <div id="editor-panel-header" class="p-3 bg-base-300 border-b border-base-content/10 flex justify-between items-center gap-3 flex-shrink-0">
        <h2 class="text-sm font-semibold text-base-content">Floorplan DSL</h2>
        <div class="flex items-center gap-3">
          <button class="btn btn-sm btn-success" id="add-room-btn" aria-label="Add new room">+ Room</button>
          <div class="dropdown dropdown-end">
            <button class="btn btn-sm" id="export-btn" aria-haspopup="menu" aria-expanded="false">Export</button>
            <ul class="dropdown-content menu p-2 shadow bg-base-200 rounded-box w-52 z-[300]" id="export-menu">
              <li><button class="export-menu-item" data-format="dsl">Floorplan DSL <span class="text-base-content/50 text-xs">.floorplan</span></button></li>
              <li><button class="export-menu-item" data-format="json">JSON Data <span class="text-base-content/50 text-xs">.json</span></button></li>
              <li class="divider"></li>
              <li><button class="export-menu-item" data-format="glb">3D Model (Binary) <span class="text-base-content/50 text-xs">.glb</span></button></li>
              <li><button class="export-menu-item" data-format="gltf">3D Model (Text) <span class="text-base-content/50 text-xs">.gltf</span></button></li>
            </ul>
          </div>
          <span id="editor-status" class="text-xs text-base-content/60">Ready</span>
        </div>
      </div>
      <div id="editor-container" class="flex-1 overflow-hidden min-h-0 bg-base-300"></div>
    </div>
    
    <!-- Error banners and overlays (positioned over 3D view) -->
    <div class="alert alert-error fixed top-0 left-0 right-0 z-[300] hidden" id="error-banner" role="alert" aria-live="polite"></div>
    <div class="fixed inset-0 bg-black/30 pointer-events-none z-[150] hidden border-4 border-error" id="error-overlay" aria-hidden="true">
      <div class="fixed bottom-16 left-1/2 -translate-x-1/2 bg-error text-error-content px-3 py-1.5 rounded text-xs">Viewing stale geometry</div>
    </div>
    
    <!-- Control Panel - uses DaisyUI classes -->
    <div id="controls" class="fp-control-panel">
      <!-- Camera Section -->
      <div class="fp-control-section">
        <div class="fp-section-header">Camera</div>
        <div class="fp-section-content">
          <button id="camera-mode-btn" class="btn btn-sm w-full">Switch to Orthographic</button>
          <button id="isometric-btn" class="btn btn-sm btn-ghost w-full">Isometric View</button>
          <div class="fp-control-group" id="fov-group">
            <div class="flex justify-between text-xs">
              <label class="text-base-content/60">FOV</label>
              <span id="fov-value">75°</span>
            </div>
            <input type="range" id="fov-slider" class="range range-xs" min="30" max="120" value="75" step="1">
          </div>
        </div>
      </div>
      
      <!-- Lighting Section -->
      <div class="fp-control-section collapsed">
        <div class="fp-section-header">Lighting</div>
        <div class="fp-section-content">
          <div class="fp-control-group">
            <div class="flex justify-between text-xs">
              <label class="text-base-content/60">Azimuth</label>
              <span id="light-azimuth-value">45°</span>
            </div>
            <input type="range" id="light-azimuth" class="range range-xs" min="0" max="360" value="45" step="1">
          </div>
          <div class="fp-control-group">
            <div class="flex justify-between text-xs">
              <label class="text-base-content/60">Elevation</label>
              <span id="light-elevation-value">60°</span>
            </div>
            <input type="range" id="light-elevation" class="range range-xs" min="0" max="90" value="60" step="1">
          </div>
          <div class="fp-control-group">
            <div class="flex justify-between text-xs">
              <label class="text-base-content/60">Intensity</label>
              <span id="light-intensity-value">1.0</span>
            </div>
            <input type="range" id="light-intensity" class="range range-xs" min="0" max="2" value="1" step="0.1">
          </div>
        </div>
      </div>
      
      <!-- View Section -->
      <div class="fp-control-section collapsed">
        <div class="fp-section-header">View</div>
        <div class="fp-section-content">
          <div class="flex justify-between items-center text-xs">
            <label class="text-base-content/60">Theme</label>
            <button id="theme-toggle-btn" class="btn btn-xs btn-ghost">☀️ Light</button>
          </div>
          <div class="fp-control-group">
            <div class="flex justify-between text-xs">
              <label class="text-base-content/60">Exploded View</label>
              <span id="exploded-value">0%</span>
            </div>
            <input type="range" id="exploded-view" class="range range-xs" min="0" max="100" value="0" step="1">
          </div>
        </div>
      </div>
      
      <!-- Floors Section -->
      <div class="fp-control-section">
        <div class="fp-section-header">Floors</div>
        <div class="fp-section-content">
          <div id="floor-list" class="fp-floor-list">
            <div class="text-xs text-base-content/50">Floors will appear here</div>
          </div>
          <div class="flex gap-2 mt-2">
            <button id="show-all-floors" class="btn btn-xs btn-ghost flex-1">Show All</button>
            <button id="hide-all-floors" class="btn btn-xs btn-ghost flex-1">Hide All</button>
          </div>
        </div>
      </div>
      
      <!-- 2D Overlay Section -->
      <div class="fp-control-section collapsed">
        <div class="fp-section-header">2D Overlay</div>
        <div class="fp-section-content">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" id="show-2d-overlay" class="checkbox checkbox-xs">
            <span class="label-text text-xs">Show 2D Mini-map</span>
          </label>
          <div class="fp-control-group">
            <div class="flex justify-between text-xs">
              <label class="text-base-content/60">Opacity</label>
              <span id="overlay-opacity-value">60%</span>
            </div>
            <input type="range" id="overlay-opacity" class="range range-xs" min="20" max="100" value="60" step="5">
          </div>
        </div>
      </div>
      
      <!-- Annotations Section -->
      <div class="fp-control-section collapsed">
        <div class="fp-section-header">Annotations</div>
        <div class="fp-section-content">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" id="show-area" class="checkbox checkbox-xs">
            <span class="label-text text-xs">Show Room Areas</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" id="show-dimensions" class="checkbox checkbox-xs">
            <span class="label-text text-xs">Show Dimensions</span>
          </label>
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" id="show-floor-summary" class="checkbox checkbox-xs">
            <span class="label-text text-xs">Show Floor Summary</span>
          </label>
          <div class="flex justify-between items-center text-xs mt-2">
            <label class="text-base-content/60">Area Unit</label>
            <select id="area-unit" class="select select-xs w-24">
              <option value="sqft">sq ft</option>
              <option value="sqm">sq m</option>
            </select>
          </div>
          <div class="flex justify-between items-center text-xs mt-2">
            <label class="text-base-content/60">Length Unit</label>
            <select id="length-unit" class="select select-xs w-24">
              <option value="ft" selected>feet</option>
              <option value="m">meters</option>
              <option value="cm">centimeters</option>
              <option value="in">inches</option>
              <option value="mm">millimeters</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Selection Section -->
      <div class="fp-control-section">
        <div class="fp-section-header">Selection</div>
        <div class="fp-section-content">
          <label class="label cursor-pointer justify-start gap-2">
            <input type="checkbox" id="selection-enabled" class="checkbox checkbox-xs" checked>
            <span class="label-text text-xs">Enable Selection Mode</span>
          </label>
          <div id="selection-status" class="mt-2 p-1.5 bg-success/20 border border-success/40 rounded text-xs text-success">
            ✓ Selection Mode Active (press V to toggle)
          </div>
          <label class="label cursor-pointer justify-start gap-2 mt-2">
            <input type="checkbox" id="containment-mode" class="checkbox checkbox-xs">
            <span class="label-text text-xs">Containment mode</span>
          </label>
          <div class="flex justify-between items-center text-xs mt-2">
            <span class="text-base-content/50">Marquee mode:</span>
            <span id="mode-indicator" class="text-primary">Intersection</span>
          </div>
          <div class="mt-3 pt-2 border-t border-base-content/10 text-xs text-base-content/50">
            Press <kbd class="kbd kbd-xs">H</kbd> for shortcuts
          </div>
        </div>
      </div>
    </div>
    
    <!-- 2D Overlay Mini-map Container -->
    <div id="overlay-2d" class="fp-overlay-2d">
      <div id="overlay-2d-header" class="fp-overlay-2d-header">
        <span>2D Floor Plan</span>
        <button id="overlay-2d-close" class="btn btn-xs btn-ghost btn-circle" title="Close" aria-label="Close 2D overlay">×</button>
      </div>
      <div id="overlay-2d-content" class="fp-overlay-2d-content">
        <span id="overlay-2d-empty" class="fp-overlay-2d-empty">2D view will appear here</span>
      </div>
      <div id="overlay-2d-resize" class="fp-overlay-2d-resize"></div>
    </div>
    
    <!-- Floor Summary Panel -->
    <div id="floor-summary" class="fp-floor-summary-panel">
      <div class="text-xs font-semibold mb-2">Floor Summary</div>
      <div id="floor-summary-content"></div>
    </div>
    
    <div id="selection-info" class="fp-selection-info" role="status" aria-live="polite" aria-label="Selection status">
      <div class="details">No selection</div>
    </div>
    
    <!-- Properties Panel (shown when single element selected) -->
    <div id="properties-panel" class="fp-properties-panel" role="complementary" aria-label="Properties panel"></div>
    
    <!-- Delete Confirm Dialog -->
    <dialog class="modal" id="delete-confirm-dialog">
      <div class="modal-box">
        <h3 class="font-bold text-lg">Delete <span id="delete-entity-name"></span>?</h3>
        <p class="py-4" id="delete-message"></p>
        <div id="delete-warning" class="alert alert-warning text-sm hidden">
          <div>
            <div class="font-semibold">⚠️ This will also delete:</div>
            <ul class="list-disc list-inside mt-1" id="delete-cascade-list"></ul>
          </div>
        </div>
        <div class="modal-action">
          <button class="btn" id="delete-cancel">Cancel</button>
          <button class="btn btn-error" id="delete-confirm">Delete</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
    
    <!-- Keyboard Help Dialog -->
    <dialog class="modal" id="keyboard-help-overlay">
      <div class="modal-box max-w-2xl">
        <div class="flex justify-between items-center mb-4 pb-3 border-b border-base-content/10">
          <h2 class="text-lg font-bold">Keyboard Shortcuts</h2>
          <form method="dialog">
            <button class="btn btn-sm btn-ghost btn-circle">×</button>
          </form>
        </div>
        <div class="grid grid-cols-2 gap-6">
          <div>
            <h3 class="text-xs font-semibold uppercase tracking-wide text-primary mb-3">Navigation</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">W</kbd><kbd class="kbd kbd-xs">A</kbd><kbd class="kbd kbd-xs">S</kbd><kbd class="kbd kbd-xs">D</kbd></div><span class="text-base-content/60">Pan camera</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">Q</kbd><kbd class="kbd kbd-xs">E</kbd></div><span class="text-base-content/60">Move down / up</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">+</kbd><kbd class="kbd kbd-xs">-</kbd></div><span class="text-base-content/60">Zoom in / out</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">Shift</kbd></div><span class="text-base-content/60">Precision mode</span></div>
            </div>
            <h3 class="text-xs font-semibold uppercase tracking-wide text-primary mb-3 mt-6">Views</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">1</kbd></div><span class="text-base-content/60">Front view</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">3</kbd></div><span class="text-base-content/60">Right view</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">7</kbd></div><span class="text-base-content/60">Top view</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">5</kbd></div><span class="text-base-content/60">Toggle ortho/perspective</span></div>
            </div>
          </div>
          <div>
            <h3 class="text-xs font-semibold uppercase tracking-wide text-primary mb-3">Camera</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">Home</kbd></div><span class="text-base-content/60">Reset camera</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">F</kbd></div><span class="text-base-content/60">Frame geometry</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">C</kbd></div><span class="text-base-content/60">Center pivot</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">P</kbd></div><span class="text-base-content/60">Toggle pivot indicator</span></div>
            </div>
            <h3 class="text-xs font-semibold uppercase tracking-wide text-primary mb-3 mt-6">Selection</h3>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">Click</kbd></div><span class="text-base-content/60">Select</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">Shift</kbd><kbd class="kbd kbd-xs">Click</kbd></div><span class="text-base-content/60">Add to selection</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">⌘</kbd><kbd class="kbd kbd-xs">A</kbd></div><span class="text-base-content/60">Select all</span></div>
              <div class="flex justify-between"><div><kbd class="kbd kbd-xs">Esc</kbd></div><span class="text-base-content/60">Deselect</span></div>
            </div>
          </div>
        </div>
        <div class="mt-6 pt-3 border-t border-base-content/10 text-center text-xs text-base-content/50">
          Press <kbd class="kbd kbd-xs">H</kbd> or <kbd class="kbd kbd-xs">?</kbd> to toggle this help
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
    
    <!-- Add Room Dialog -->
    <dialog class="modal" id="add-room-dialog">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Add New Room</h3>
        <div class="form-control mb-3">
          <label class="label" for="room-name">
            <span class="label-text">Room Name</span>
          </label>
          <input type="text" id="room-name" class="input input-bordered" placeholder="e.g., Bedroom, Office" autocomplete="off">
        </div>
        <div class="grid grid-cols-2 gap-4 mb-3">
          <div class="form-control">
            <label class="label" for="room-x">
              <span class="label-text">X Position</span>
            </label>
            <input type="number" id="room-x" class="input input-bordered" value="0" step="0.5">
          </div>
          <div class="form-control">
            <label class="label" for="room-y">
              <span class="label-text">Y Position</span>
            </label>
            <input type="number" id="room-y" class="input input-bordered" value="0" step="0.5">
          </div>
        </div>
        <div class="grid grid-cols-2 gap-4 mb-3">
          <div class="form-control">
            <label class="label" for="room-width">
              <span class="label-text">Width</span>
            </label>
            <input type="number" id="room-width" class="input input-bordered" value="4" step="0.5" min="0.5">
          </div>
          <div class="form-control">
            <label class="label" for="room-height">
              <span class="label-text">Height</span>
            </label>
            <input type="number" id="room-height" class="input input-bordered" value="4" step="0.5" min="0.5">
          </div>
        </div>
        <div class="text-error text-sm" id="add-room-error"></div>
        <div class="modal-action">
          <button class="btn" id="add-room-cancel">Cancel</button>
          <button class="btn btn-primary" id="add-room-confirm">Add Room</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
    
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
